<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CargoLens | Zambia Logistics Platform</title>
     <!-- ULTIMATE CARGO-LENS LOGO -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='a' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%232563eb'/><stop offset='50%' stop-color='%231d4ed8'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='b' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%2310b981'/><stop offset='100%' stop-color='%23047857'/></linearGradient><filter id='s'><feDropShadow dx='1' dy='1' stdDeviation='1.5' flood-color='rgba(0,0,0,0.15)'/></filter></defs><rect width='100' height='100' fill='white'/><g filter='url(%23s)'><path d='M20 65h60V45h10V25H60v10H40V25H10v40h10z' fill='url(%23a)'/></g><circle cx='25' cy='82' r='8' fill='%231e293b' filter='url(%23s)'/><circle cx='25' cy='82' r='5' fill='%23f8fafc'/><circle cx='75' cy='82' r='8' fill='%231e293b' filter='url(%23s)'/><circle cx='75' cy='82' r='5' fill='%23f8fafc'/><rect x='45' y='50' width='10' height='12' fill='white' rx='1' filter='url(%23s)'/><g filter='url(%23s)'><circle cx='85' cy='20' r='14' fill='url(%23b)' stroke='white' stroke-width='2'/><circle cx='85' cy='20' r='8' fill='none' stroke='white' stroke-width='1.5' opacity='0.6'/><circle cx='85' cy='20' r='4' fill='none' stroke='white' stroke-width='1.5' opacity='0.6'/><path d='M85 20l5.2 3' stroke='white' stroke-width='2' stroke-linecap='round'/><circle cx='85' cy='20' r='2' fill='white'/></g></svg>" type="image/svg+xml">
    
    <!-- For Apple devices -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='a' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%232563eb'/><stop offset='50%' stop-color='%231d4ed8'/><stop offset='100%' stop-color='%231e40af'/></linearGradient><linearGradient id='b' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' stop-color='%2310b981'/><stop offset='100%' stop-color='%23047857'/></linearGradient><filter id='s'><feDropShadow dx='1' dy='1' stdDeviation='1.5' flood-color='rgba(0,0,0,0.15)'/></filter></defs><rect width='100' height='100' fill='white'/><g filter='url(%23s)'><path d='M20 65h60V45h10V25H60v10H40V25H10v40h10z' fill='url(%23a)'/></g><circle cx='25' cy='82' r='8' fill='%231e293b' filter='url(%23s)'/><circle cx='25' cy='82' r='5' fill='%23f8fafc'/><circle cx='75' cy='82' r='8' fill='%231e293b' filter='url(%23s)'/><circle cx='75' cy='82' r='5' fill='%23f8fafc'/><rect x='45' y='50' width='10' height='12' fill='white' rx='1' filter='url(%23s)'/><g filter='url(%23s)'><circle cx='85' cy='20' r='14' fill='url(%23b)' stroke='white' stroke-width='2'/><circle cx='85' cy='20' r='8' fill='none' stroke='white' stroke-width='1.5' opacity='0.6'/><circle cx='85' cy='20' r='4' fill='none' stroke='white' stroke-width='1.5' opacity='0.6'/><path d='M85 20l5.2 3' stroke='white' stroke-width='2' stroke-linecap='round'/><circle cx='85' cy='20' r='2' fill='white'/></g></svg>">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
 <!-- Charts - Latest stable version -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    
    <!-- Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- QR Scanner -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #94a3b8;
            --gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            --gradient-dark: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius: 12px;
            --radius-lg: 16px;
            --sidebar-width: 280px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9;
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-dark);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            transition: opacity 0.5s ease;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 20px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Auth Page */
        .auth-container {
            min-height: 100vh;
            background: var(--gradient);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .auth-container.hidden {
            display: none;
        }
        
        .auth-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 40px 30px;
            width: 100%;
            max-width: 420px;
            box-shadow: var(--shadow-lg);
        }
        
        .auth-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--dark);
            font-family: 'Montserrat', sans-serif;
        }
        
        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            color: var(--dark);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn {
            padding: 14px 24px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: none;
            font-size: 1rem;
            font-family: 'Montserrat', sans-serif;
        }
        
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .demo-accounts {
            margin-top: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: var(--radius);
        }
        
        .demo-accounts h4 {
            margin-bottom: 15px;
            color: var(--dark);
            font-size: 1rem;
        }
        
        .demo-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 12px 15px;
            background: white;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .demo-account:hover {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
        }
        
        /* Dashboard Layout */
        .dashboard-container {
            display: none;
            min-height: 100vh;
            position: relative;
        }
        
        .dashboard-container.active {
            display: flex;
            flex-direction: column;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: white;
            box-shadow: 2px 0 20px rgba(0,0,0,0.08);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            font-family: 'Montserrat', sans-serif;
        }
        
        .sidebar-nav {
            padding: 20px 0;
        }
        
        .nav-section {
            margin-bottom: 30px;
        }
        
        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px 10px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 20px;
            color: var(--secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            font-weight: 500;
            border-left: 4px solid transparent;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
        }
        
        .nav-item:hover,
        .nav-item.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.08) 0%, rgba(37, 99, 235, 0.04) 100%);
            color: var(--primary);
            border-left-color: var(--primary);
        }
        
        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #f1f5f9;
            margin-top: auto;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--dark);
            margin-bottom: 2px;
        }
        
        .user-role {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        /* Header */
        .main-header {
            background: white;
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 900;
        }
        
        @media (min-width: 1024px) {
            .main-header {
                margin-left: var(--sidebar-width);
                width: calc(100% - var(--sidebar-width));
            }
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .header-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        @media (min-width: 768px) {
            .header-title {
                font-size: 1.5rem;
            }
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .search-bar {
            position: relative;
            width: 300px;
            display: none;
        }
        
        @media (min-width: 768px) {
            .search-bar {
                display: block;
            }
        }
        
        .search-bar.active {
            display: block;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
        }
        
        .search-bar input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius);
            background: #f8fafc;
            font-size: 0.95rem;
        }
        
        .search-bar i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .header-icons {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8fafc;
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: none;
            font-size: 1.1rem;
        }
        
        .icon-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }
        
        /* Main Content */
        .main-content {
            padding: 20px;
            flex: 1;
            width: 100%;
        }
        
        @media (min-width: 1024px) {
            .main-content {
                margin-left: var(--sidebar-width);
                padding: 30px;
            }
        }
        
        /* Page Content */
        .page-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .page-content.active {
            display: block;
        }
        
        .page-title {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 10px;
        }
        
        @media (min-width: 768px) {
            .page-title {
                font-size: 2rem;
            }
        }
        
        .page-subtitle {
            font-size: 1rem;
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            background: var(--gradient);
        }
        
        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
            font-family: 'Montserrat', sans-serif;
        }
        
        .stat-card-trend {
            font-size: 0.9rem;
            color: var(--success);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-card-trend.down {
            color: var(--danger);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Tables */
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius);
            background: white;
            box-shadow: var(--shadow);
            margin-top: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid #f1f5f9;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        tr:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        
        .status-delivered { background: #dcfce7; color: #166534; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-in-transit { background: #dbeafe; color: #1e40af; }
        .status-failed { background: #fee2e2; color: #991b1b; }
        .status-active { background: #dcfce7; color: #166534; }
        .status-offline { background: #f1f5f9; color: #64748b; }
        
        /* Map */
        .map-container {
            height: 400px;
            border-radius: var(--radius);
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        #adminMap, #driverMap, #dispatcherMap {
            width: 100%;
            height: 100%;
        }
        
        /* Analytics Charts */
        .chart-container {
            height: 300px;
            margin-top: 20px;
            position: relative;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (min-width: 768px) {
            .quick-actions {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .action-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            background: var(--gradient);
            color: white;
            border-color: transparent;
        }
        
        .action-card:hover .action-icon {
            color: white;
        }
        
        .action-icon {
            font-size: 2rem;
            color: var(--primary);
        }
        
        /* Delivery Card */
        .delivery-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }
        
        .delivery-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .delivery-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* Progress Bar */
        .progress-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        
        .close-btn:hover {
            background: #f1f5f9;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 16px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 90%;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: var(--danger); }
        .toast.warning { background: var(--warning); }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 15px 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.1);
            z-index: 1000;
            border-top: 1px solid #f1f5f9;
        }
        
        @media (min-width: 1024px) {
            .bottom-nav {
                display: none;
            }
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: var(--gray);
            font-size: 0.8rem;
            border: none;
            background: none;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }
        
        .bottom-nav-item.active {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.08);
        }
        
        .bottom-nav-icon {
            font-size: 1.3rem;
        }
        
        /* Profile Button in Mobile Header */
        .profile-btn-mobile {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
            border-radius: var(--radius);
            transition: background 0.3s ease;
        }
        
        .profile-btn-mobile:hover {
            background: #f1f5f9;
        }
        
        @media (min-width: 1024px) {
            .profile-btn-mobile {
                display: none;
            }
        }
        
        /* Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            backdrop-filter: blur(4px);
        }
        
        @media (max-width: 1023px) {
            .sidebar-overlay.active {
                display: block;
            }
        }
        
        /* Menu Toggle */
        .menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--dark);
            cursor: pointer;
            border-radius: var(--radius);
            transition: background 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: #f1f5f9;
        }
        
        @media (min-width: 1024px) {
            .menu-toggle {
                display: none;
            }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 20px;
            color: #e2e8f0;
            opacity: 0.7;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Profile Modal */
        .profile-modal-content {
            max-width: 400px;
        }
        
        .profile-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 2rem;
            margin: 0 auto 15px;
        }
        
        /* Driver specific styles */
        .driver-task-card {
            background: white;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--warning);
        }
        
        .scan-qr-btn {
            background: var(--gradient);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .scan-qr-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        /* Dispatcher specific styles */
        .priority-high { background: #fee2e2; color: #991b1b; }
        .priority-medium { background: #fef3c7; color: #92400e; }
        .priority-low { background: #dbeafe; color: #1e40af; }
        
        .dispatch-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-shipping-fast"></i>
            <span>CargoLens</span>
        </div>
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-size: 1rem;">Loading Zambia Logistics Platform...</p>
    </div>
    
    <!-- Auth Page -->
    <div class="auth-container" id="authPage">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-shipping-fast"></i>
                <span>CargoLens</span>
            </div>
            
            <h2 class="auth-title">Welcome to CargoLens</h2>
            
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-control" id="authEmail" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="authPassword" placeholder="Enter your password" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In / Sign Up
                </button>
            </form>
            
            <div class="demo-accounts">
                <h4>Demo Accounts (Click to Try):</h4>
                <div class="demo-account" data-email="admin@cargolens.co.zm" data-password="admin123">
                    <span>Administrator</span>
                    <span>Full system control</span>
                </div>
                <div class="demo-account" data-email="driver@cargolens.co.zm" data-password="driver123">
                    <span>Driver</span>
                    <span>Delivery operations</span>
                </div>
                <div class="demo-account" data-email="dispatcher@cargolens.co.zm" data-password="dispatcher123">
                    <span>Dispatcher</span>
                    <span>Route & task management</span>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 25px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <p style="color: var(--gray); font-size: 0.9rem;">CargoLens Logistics Platform v2.0.<br>Developed by GeeTech</br></p>
            </div>
        </div>
    </div>
    
    <!-- ADMIN Dashboard -->
    <div class="dashboard-container" id="adminDashboard">
        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shipping-fast"></i>
                    <span>CargoLens</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <button class="nav-item active" data-page="admin-overview">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Overview</span>
                    </button>
                    <button class="nav-item" data-page="admin-analytics">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <button class="nav-item" data-page="admin-packages">
                        <i class="fas fa-boxes"></i>
                        <span>Shipments</span>
                    </button>
                    <button class="nav-item" data-page="admin-drivers">
                        <i class="fas fa-truck"></i>
                        <span>Drivers</span>
                    </button>
                    <button class="nav-item" data-page="admin-routes">
                        <i class="fas fa-route"></i>
                        <span>Routes</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Tracking</div>
                    <button class="nav-item" data-page="admin-tracking">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Live Tracking</span>
                    </button>
                    <button class="nav-item" data-page="admin-reports">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="adminAvatar">A</div>
                    <div class="user-info">
                        <div class="user-name" id="adminUserName">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                    <button class="icon-btn logout-btn" id="adminLogoutBtn" style="background: transparent; color: var(--dark);">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div style="flex: 1; overflow: hidden;">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" id="pageTitle">Dashboard</h1>
                </div>
                
                <div class="header-actions">
                    <div class="search-bar" id="searchBar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Search...">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                    
                    <div class="header-icons">
                        <button class="icon-btn mobile-only" id="searchToggle">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="profile-btn-mobile" id="profileBtnMobile">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="icon-btn" id="adminAddBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Overview Page -->
                <div class="page-content active" id="admin-overview">
                    <h1 class="page-title">Admin Dashboard</h1>
                    <div class="page-subtitle" id="dashboardSubtitle">Full system control and monitoring</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Total Shipments</div>
                                <div class="stat-card-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalShipments">87</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>12% this month</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Across all cities</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Active Deliveries</div>
                                <div class="stat-card-icon" style="background: var(--success);">
                                    <i class="fas fa-shipping-fast"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="activeDeliveries">23</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-check-circle"></i>
                                <span>On schedule</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Currently in transit</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Active Drivers</div>
                                <div class="stat-card-icon" style="background: var(--warning);">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="activeDrivers">15</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-user-check"></i>
                                <span>All verified</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Online and available</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Revenue</div>
                                <div class="stat-card-icon" style="background: var(--primary-dark);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="totalRevenue">ZK 245,800</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-chart-line"></i>
                                <span>18% growth</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">This month</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Recent Shipments</h2>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--primary); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Chanda Bwalya</div>
                                                <div style="font-size: 0.85rem; color: var(--gray);">CL-2024-087 • Lusaka</div>
                                            </div>
                                        </div>
                                        <span class="status-badge status-in-transit">IN TRANSIT</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--warning); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Mwila Phiri</div>
                                                <div style="font-size: 0.85rem; color: var(--gray);">CL-2024-086 • Ndola</div>
                                            </div>
                                        </div>
                                        <span class="status-badge status-pending">PENDING</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #f8fafc; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--success); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Bwalya Lungu</div>
                                                <div style="font-size: 0.85rem; color: var(--gray);">CL-2024-085 • Kitwe</div>
                                            </div>
                                        </div>
                                        <span class="status-badge status-delivered">DELIVERED</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Quick Actions</h2>
                            </div>
                            <div class="quick-actions">
                                <button class="action-card" onclick="showModal('addPackageModal')">
                                    <i class="action-icon fas fa-plus-circle"></i>
                                    <span>New Shipment</span>
                                </button>
                                <button class="action-card" onclick="navigateToPage('admin-drivers')">
                                    <i class="action-icon fas fa-user-plus"></i>
                                    <span>Add Driver</span>
                                </button>
                                <button class="action-card" onclick="navigateToPage('admin-tracking')">
                                    <i class="action-icon fas fa-map-marker-alt"></i>
                                    <span>Live Map</span>
                                </button>
                                <button class="action-card" onclick="showProfileModal()">
                                    <i class="action-icon fas fa-user"></i>
                                    <span>Profile</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Page -->
                <div class="page-content" id="admin-analytics">
                    <h1 class="page-title">Analytics</h1>
                    <div class="page-subtitle">Business performance metrics</div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <h2 class="card-title">Shipment Volume</h2>
                            <div class="chart-container">
                                <canvas id="adminShipmentChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h2 class="card-title">Revenue Trends</h2>
                            <div class="chart-container">
                                <canvas id="adminRevenueChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Packages Page -->
                <div class="page-content" id="admin-packages">
                    <h1 class="page-title">Shipments</h1>
                    <div class="page-subtitle">Manage all shipments in the system</div>
                    
                    <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showModal('addPackageModal')">
                            <i class="fas fa-plus"></i> New Shipment
                        </button>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">All Shipments</h2>
                            <select class="form-control" style="width: auto; padding: 8px 16px;" onchange="filterShipments(this.value)">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="in-transit">In Transit</option>
                                <option value="delivered">Delivered</option>
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Tracking ID</th>
                                        <th>Recipient</th>
                                        <th>Destination</th>
                                        <th>Status</th>
                                        <th>Driver</th>
                                        <th>Value</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="allShipmentsTable">
                                    <!-- Will be filled dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Drivers Page -->
                <div class="page-content" id="admin-drivers">
                    <h1 class="page-title">Drivers</h1>
                    <div class="page-subtitle">Manage your delivery team</div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Driver Map</h2>
                            </div>
                            <div class="map-container" style="height: 350px;">
                                <div id="adminMap"></div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Add New Driver</h2>
                            </div>
                            <div style="padding: 20px;">
                                <form id="addDriverForm">
                                    <div class="form-group">
                                        <label class="form-label">Driver Name</label>
                                        <input type="text" class="form-control" id="driverName" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Phone Number</label>
                                        <input type="tel" class="form-control" id="driverPhone" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Vehicle Type</label>
                                        <input type="text" class="form-control" id="driverVehicle" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Base City</label>
                                        <select class="form-control" id="driverCity" required>
                                            <option value="">Select city</option>
                                            <option value="lusaka">Lusaka</option>
                                            <option value="ndola">Ndola</option>
                                            <option value="kitwe">Kitwe</option>
                                            <option value="livingstone">Livingstone</option>
                                            <option value="kabwe">Kabwe</option>
                                        </select>
                                    </div>
                                    
                                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                                        <i class="fas fa-user-plus"></i> Add Driver
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h2 class="card-title">All Drivers</h2>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Driver</th>
                                        <th>Contact</th>
                                        <th>Vehicle</th>
                                        <th>Status</th>
                                        <th>Rating</th>
                                        <th>Deliveries</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="driversTable">
                                    <!-- Will be filled dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Live Tracking Page -->
                <div class="page-content" id="admin-tracking">
                    <h1 class="page-title">Live Tracking</h1>
                    <div class="page-subtitle">Real-time tracking of shipments</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Zambia Operations Map</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm" onclick="zoomToLusaka()">
                                    <i class="fas fa-search-location"></i> Lusaka
                                </button>
                                <button class="btn btn-sm" onclick="zoomToNdola()">
                                    <i class="fas fa-search-location"></i> Ndola
                                </button>
                            </div>
                        </div>
                        <div class="map-container" style="height: 500px;">
                            <div id="adminTrackingMap"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div class="page-content" id="admin-reports">
                    <h1 class="page-title">Reports</h1>
                    <div class="page-subtitle">Generate business reports</div>
                    
                    <div id="reportsContent">
                        <!-- Will be filled dynamically -->
                    </div>
                </div>
                
                <!-- Routes Page -->
                <div class="page-content" id="admin-routes">
                    <h1 class="page-title">Routes</h1>
                    <div class="page-subtitle">Manage delivery routes</div>
                    
                    <div id="routesContent">
                        <!-- Will be filled dynamically -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation for Mobile -->
        <div class="bottom-nav">
            <button class="bottom-nav-item active" onclick="navigateToPage('admin-overview')">
                <i class="bottom-nav-icon fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('admin-packages')">
                <i class="bottom-nav-icon fas fa-box"></i>
                <span>Shipments</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('admin-tracking')">
                <i class="bottom-nav-icon fas fa-map"></i>
                <span>Tracking</span>
            </button>
            <button class="bottom-nav-item" onclick="showProfileModal()">
                <i class="bottom-nav-icon fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>
    
    <!-- DRIVER Dashboard -->
    <div class="dashboard-container" id="driverDashboard">
        <div class="sidebar-overlay" id="driverSidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="driverSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shipping-fast"></i>
                    <span>CargoLens</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <button class="nav-item active" data-page="driver-overview">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Overview</span>
                    </button>
                    <button class="nav-item" data-page="driver-tasks">
                        <i class="fas fa-tasks"></i>
                        <span>My Tasks</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <button class="nav-item" data-page="driver-deliveries">
                        <i class="fas fa-boxes"></i>
                        <span>Deliveries</span>
                    </button>
                    <button class="nav-item" data-page="driver-map">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Route Map</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Tools</div>
                    <button class="nav-item" data-page="driver-scanner">
                        <i class="fas fa-qrcode"></i>
                        <span>QR Scanner</span>
                    </button>
                    <button class="nav-item" data-page="driver-history">
                        <i class="fas fa-history"></i>
                        <span>History</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="driverAvatar">D</div>
                    <div class="user-info">
                        <div class="user-name" id="driverUserName">Driver</div>
                        <div class="user-role">Delivery Driver</div>
                    </div>
                    <button class="icon-btn logout-btn" id="driverLogoutBtn" style="background: transparent; color: var(--dark);">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div style="flex: 1; overflow: hidden;">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" id="driverMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" id="driverPageTitle">Dashboard</h1>
                </div>
                
                <div class="header-actions">
                    <div class="header-icons">
                        <button class="profile-btn-mobile" id="driverProfileBtnMobile">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="icon-btn" id="driverStatusBtn">
                            <i class="fas fa-power-off"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Overview Page -->
                <div class="page-content active" id="driver-overview">
                    <h1 class="page-title">Driver Dashboard</h1>
                    <div class="page-subtitle" id="driverDashboardSubtitle">Welcome Mike Johnson</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Today's Deliveries</div>
                                <div class="stat-card-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="driverTodayDeliveries">8</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-clock"></i>
                                <span>4 remaining</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Lusaka routes</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Completed</div>
                                <div class="stat-card-icon" style="background: var(--success);">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="driverCompleted">4</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-thumbs-up"></i>
                                <span>On time</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Perfect record</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Earnings Today</div>
                                <div class="stat-card-icon" style="background: var(--warning);">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="driverEarnings">ZK 1,240</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-chart-line"></i>
                                <span>+15% from avg</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Target: ZK 1,500</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Rating</div>
                                <div class="stat-card-icon" style="background: var(--primary-dark);">
                                    <i class="fas fa-star"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="driverRating">4.8</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-heart"></i>
                                <span>245 reviews</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Top performer</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Current Delivery</h2>
                                <span class="status-badge status-in-transit">IN PROGRESS</span>
                            </div>
                            <div class="driver-task-card">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <div>
                                        <h3 style="margin-bottom: 5px;">Chanda Bwalya</h3>
                                        <p style="color: var(--gray); font-size: 0.9rem;">CL-2024-087</p>
                                    </div>
                                    <span class="status-badge priority-high">URGENT</span>
                                </div>
                                
                                <div style="margin-bottom: 15px;">
                                    <p style="margin-bottom: 8px;"><i class="fas fa-map-marker-alt" style="color: var(--primary); margin-right: 8px;"></i>123 Cairo Road, Lusaka</p>
                                    <p><i class="fas fa-phone" style="color: var(--primary); margin-right: 8px;"></i>+260 966 111 222</p>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <p style="font-size: 0.9rem; color: var(--gray);">Estimated arrival:</p>
                                        <p style="font-weight: 600;">2:30 PM (45 mins)</p>
                                    </div>
                                    <button class="scan-qr-btn">
                                        <i class="fas fa-qrcode"></i>
                                        Scan QR
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Quick Actions</h2>
                            </div>
                            <div class="quick-actions">
                                <button class="action-card" onclick="navigateToPage('driver-scanner')">
                                    <i class="action-icon fas fa-qrcode"></i>
                                    <span>Scan QR</span>
                                </button>
                                <button class="action-card" onclick="updateDriverStatus()">
                                    <i class="action-icon fas fa-power-off"></i>
                                    <span>Go Online</span>
                                </button>
                                <button class="action-card" onclick="navigateToPage('driver-map')">
                                    <i class="action-icon fas fa-map"></i>
                                    <span>View Route</span>
                                </button>
                                <button class="action-card" onclick="showProfileModal()">
                                    <i class="action-icon fas fa-user"></i>
                                    <span>Profile</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tasks Page -->
                <div class="page-content" id="driver-tasks">
                    <h1 class="page-title">My Tasks</h1>
                    <div class="page-subtitle">Today's delivery assignments</div>
                    
                    <div id="driverTasksContent">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
                
                <!-- Deliveries Page -->
                <div class="page-content" id="driver-deliveries">
                    <h1 class="page-title">My Deliveries</h1>
                    <div class="page-subtitle">Track all your deliveries</div>
                    
                    <div id="driverDeliveriesContent">
                        <!-- Deliveries will be loaded here -->
                    </div>
                </div>
                
                <!-- Map Page -->
                <div class="page-content" id="driver-map">
                    <h1 class="page-title">Route Map</h1>
                    <div class="page-subtitle">Your delivery route for today</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Today's Route: Lusaka Central</h2>
                            <button class="btn btn-sm" onclick="refreshDriverMap()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="map-container" style="height: 500px;">
                            <div id="driverMap"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Scanner Page -->
                <div class="page-content" id="driver-scanner">
                    <h1 class="page-title">QR Scanner</h1>
                    <div class="page-subtitle">Scan package QR codes</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Scan Delivery QR</h2>
                        </div>
                        <div style="padding: 40px; text-align: center;">
                            <div style="width: 300px; height: 300px; background: #f8fafc; border: 2px dashed var(--gray); border-radius: var(--radius); margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; color: var(--gray);">
                                <i class="fas fa-qrcode" style="font-size: 5rem;"></i>
                            </div>
                            <p style="margin-bottom: 20px; color: var(--gray);">Position QR code within frame to scan</p>
                            <button class="btn btn-primary" style="padding: 15px 30px;">
                                <i class="fas fa-camera"></i> Start Scanning
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- History Page -->
                <div class="page-content" id="driver-history">
                    <h1 class="page-title">Delivery History</h1>
                    <div class="page-subtitle">Past delivery records</div>
                    
                    <div id="driverHistoryContent">
                        <!-- History will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation for Mobile -->
        <div class="bottom-nav">
            <button class="bottom-nav-item active" onclick="navigateToPage('driver-overview')">
                <i class="bottom-nav-icon fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('driver-tasks')">
                <i class="bottom-nav-icon fas fa-tasks"></i>
                <span>Tasks</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('driver-scanner')">
                <i class="bottom-nav-icon fas fa-qrcode"></i>
                <span>Scan</span>
            </button>
            <button class="bottom-nav-item" onclick="showProfileModal()">
                <i class="bottom-nav-icon fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>
    
    <!-- DISPATCHER Dashboard -->
    <div class="dashboard-container" id="dispatcherDashboard">
        <div class="sidebar-overlay" id="dispatcherSidebarOverlay"></div>
        
        <!-- Sidebar -->
        <div class="sidebar" id="dispatcherSidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-shipping-fast"></i>
                    <span>CargoLens</span>
                </div>
            </div>
            
            <div class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <button class="nav-item active" data-page="dispatcher-overview">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Overview</span>
                    </button>
                    <button class="nav-item" data-page="dispatcher-assignments">
                        <i class="fas fa-tasks"></i>
                        <span>Assignments</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <button class="nav-item" data-page="dispatcher-drivers">
                        <i class="fas fa-truck"></i>
                        <span>Drivers</span>
                    </button>
                    <button class="nav-item" data-page="dispatcher-routes">
                        <i class="fas fa-route"></i>
                        <span>Routes</span>
                    </button>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Tracking</div>
                    <button class="nav-item" data-page="dispatcher-tracking">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Live Tracking</span>
                    </button>
                    <button class="nav-item" data-page="dispatcher-alerts">
                        <i class="fas fa-bell"></i>
                        <span>Alerts</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="dispatcherAvatar">D</div>
                    <div class="user-info">
                        <div class="user-name" id="dispatcherUserName">Dispatcher</div>
                        <div class="user-role">Operations Manager</div>
                    </div>
                    <button class="icon-btn logout-btn" id="dispatcherLogoutBtn" style="background: transparent; color: var(--dark);">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div style="flex: 1; overflow: hidden;">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" id="dispatcherMenuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="header-title" id="dispatcherPageTitle">Dashboard</h1>
                </div>
                
                <div class="header-actions">
                    <div class="header-icons">
                        <button class="profile-btn-mobile" id="dispatcherProfileBtnMobile">
                            <i class="fas fa-user"></i>
                        </button>
                        <button class="icon-btn" id="dispatcherAlertBtn">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge">3</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Overview Page -->
                <div class="page-content active" id="dispatcher-overview">
                    <h1 class="page-title">Dispatcher Dashboard</h1>
                    <div class="page-subtitle" id="dispatcherDashboardSubtitle">Operations control center</div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Pending Assignments</div>
                                <div class="stat-card-icon">
                                    <i class="fas fa-clipboard-list"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="dispatcherPending">12</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-clock"></i>
                                <span>Require action</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Needs driver assignment</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Active Drivers</div>
                                <div class="stat-card-icon" style="background: var(--success);">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="dispatcherActiveDrivers">8</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-user-check"></i>
                                <span>Online now</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Available for assignments</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>Urgent Deliveries</div>
                                <div class="stat-card-icon" style="background: var(--danger);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="dispatcherUrgent">5</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-clock"></i>
                                <span>Time sensitive</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Require immediate dispatch</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-card-header">
                                <div>On-time Rate</div>
                                <div class="stat-card-icon" style="background: var(--primary-dark);">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                            <div class="stat-card-value" id="dispatcherOnTimeRate">94%</div>
                            <div class="stat-card-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>+2% this week</span>
                            </div>
                            <div style="font-size: 0.9rem; color: var(--gray); margin-top: 8px;">Delivery performance</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Priority Assignments</h2>
                                <button class="btn btn-sm" onclick="navigateToPage('dispatcher-assignments')">
                                    View All
                                </button>
                            </div>
                            <div style="padding: 20px;">
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #fee2e2; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--danger); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-exclamation"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Medical Supplies</div>
                                                <div style="font-size: 0.85rem; color: #991b1b;">CL-2024-091 • UTH, Lusaka</div>
                                            </div>
                                        </div>
                                        <span class="status-badge priority-high">URGENT</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #fef3c7; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--warning); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Business Documents</div>
                                                <div style="font-size: 0.85rem; color: #92400e;">CL-2024-092 • Manda Hill</div>
                                            </div>
                                        </div>
                                        <span class="status-badge priority-medium">HIGH</span>
                                    </div>
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #dbeafe; border-radius: var(--radius);">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <div style="background: var(--primary); color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                                <i class="fas fa-box"></i>
                                            </div>
                                            <div>
                                                <div style="font-weight: 600;">Office Supplies</div>
                                                <div style="font-size: 0.85rem; color: #1e40af;">CL-2024-093 • Woodlands</div>
                                            </div>
                                        </div>
                                        <span class="status-badge priority-low">STANDARD</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <h2 class="card-title">Quick Actions</h2>
                            </div>
                            <div class="quick-actions">
                                <button class="action-card" onclick="assignNewDelivery()">
                                    <i class="action-icon fas fa-plus-circle"></i>
                                    <span>New Assignment</span>
                                </button>
                                <button class="action-card" onclick="navigateToPage('dispatcher-drivers')">
                                    <i class="action-icon fas fa-truck"></i>
                                    <span>Manage Drivers</span>
                                </button>
                                <button class="action-card" onclick="navigateToPage('dispatcher-tracking')">
                                    <i class="action-icon fas fa-map-marker-alt"></i>
                                    <span>Live Tracking</span>
                                </button>
                                <button class="action-card" onclick="showProfileModal()">
                                    <i class="action-icon fas fa-user"></i>
                                    <span>Profile</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assignments Page -->
                <div class="page-content" id="dispatcher-assignments">
                    <h1 class="page-title">Assignments</h1>
                    <div class="page-subtitle">Manage delivery assignments</div>
                    
                    <div id="dispatcherAssignmentsContent">
                        <!-- Assignments will be loaded here -->
                    </div>
                </div>
                
                <!-- Drivers Page -->
                <div class="page-content" id="dispatcher-drivers">
                    <h1 class="page-title">Driver Management</h1>
                    <div class="page-subtitle">Monitor and assign drivers</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Active Drivers</h2>
                            <button class="btn btn-sm" onclick="refreshDispatcherMap()">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="map-container" style="height: 400px;">
                            <div id="dispatcherMap"></div>
                        </div>
                    </div>
                    
                    <div class="card" style="margin-top: 30px;">
                        <div class="card-header">
                            <h2 class="card-title">Driver Status</h2>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Driver</th>
                                        <th>Status</th>
                                        <th>Current Task</th>
                                        <th>Location</th>
                                        <th>ETA</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="dispatcherDriversTable">
                                    <!-- Will be filled dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Routes Page -->
                <div class="page-content" id="dispatcher-routes">
                    <h1 class="page-title">Route Planning</h1>
                    <div class="page-subtitle">Optimize delivery routes</div>
                    
                    <div id="dispatcherRoutesContent">
                        <!-- Routes will be loaded here -->
                    </div>
                </div>
                
                <!-- Tracking Page -->
                <div class="page-content" id="dispatcher-tracking">
                    <h1 class="page-title">Live Tracking</h1>
                    <div class="page-subtitle">Real-time shipment tracking</div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Operations Map</h2>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-sm" onclick="filterByCity('lusaka')">
                                    Lusaka
                                </button>
                                <button class="btn btn-sm" onclick="filterByCity('ndola')">
                                    Ndola
                                </button>
                                <button class="btn btn-sm" onclick="filterByCity('all')">
                                    All Cities
                                </button>
                            </div>
                        </div>
                        <div class="map-container" style="height: 500px;">
                            <div id="dispatcherTrackingMap"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Alerts Page -->
                <div class="page-content" id="dispatcher-alerts">
                    <h1 class="page-title">Alerts & Notifications</h1>
                    <div class="page-subtitle">System alerts and updates</div>
                    
                    <div id="dispatcherAlertsContent">
                        <!-- Alerts will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Navigation for Mobile -->
        <div class="bottom-nav">
            <button class="bottom-nav-item active" onclick="navigateToPage('dispatcher-overview')">
                <i class="bottom-nav-icon fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('dispatcher-assignments')">
                <i class="bottom-nav-icon fas fa-tasks"></i>
                <span>Assignments</span>
            </button>
            <button class="bottom-nav-item" onclick="navigateToPage('dispatcher-tracking')">
                <i class="bottom-nav-icon fas fa-map"></i>
                <span>Tracking</span>
            </button>
            <button class="bottom-nav-item" onclick="showProfileModal()">
                <i class="bottom-nav-icon fas fa-user"></i>
                <span>Profile</span>
            </button>
        </div>
    </div>
    
    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content profile-modal-content">
            <div class="modal-header">
                <h2 class="modal-title">User Profile</h2>
                <button class="close-btn" onclick="hideModal('profileModal')">&times;</button>
            </div>
            
            <div class="profile-header">
                <div class="profile-avatar-large" id="profileAvatarLarge">U</div>
                <h3 id="profileUserName">User Name</h3>
                <p id="profileUserRole" style="color: var(--gray); margin-top: 5px;">Role</p>
            </div>
            
            <div style="padding: 20px 0;">
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                        <span>Email</span>
                        <span id="profileUserEmail" style="font-weight: 600;">user@example.com</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                        <span>Account Type</span>
                        <span id="profileAccountType" style="font-weight: 600;">Standard Account</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9;">
                        <span>Member Since</span>
                        <span id="profileMemberSince" style="font-weight: 600;">Today</span>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="logout()" style="margin-top: 20px;">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>
        </div>
    </div>

    <!-- Add Package Modal -->
    <div class="modal" id="addPackageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create New Shipment</h2>
                <button class="close-btn" onclick="hideModal('addPackageModal')">&times;</button>
            </div>
            
            <form id="addPackageForm">
                <div class="form-group">
                    <label class="form-label">Recipient Name</label>
                    <input type="text" class="form-control" id="recipientName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Recipient Phone</label>
                    <input type="tel" class="form-control" id="recipientPhone" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Destination City</label>
                    <select class="form-control" id="destinationCity" required>
                        <option value="">Select city</option>
                        <option value="lusaka">Lusaka</option>
                        <option value="ndola">Ndola</option>
                        <option value="kitwe">Kitwe</option>
                        <option value="livingstone">Livingstone</option>
                        <option value="kabwe">Kabwe</option>
                        <option value="chipata">Chipata</option>
                        <option value="solwezi">Solwezi</option>
                        <option value="mongu">Mongu</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Delivery Address</label>
                    <textarea class="form-control" id="deliveryAddress" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Package Details</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="font-size: 0.85rem; color: var(--gray);">Weight (kg)</label>
                            <input type="number" class="form-control" id="packageWeight" placeholder="0.0" step="0.1">
                        </div>
                        <div>
                            <label style="font-size: 0.85rem; color: var(--gray);">Dimensions (cm)</label>
                            <input type="text" class="form-control" id="packageDimensions" placeholder="L x W x H">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-control" id="packagePriority" required>
                        <option value="standard">Standard</option>
                        <option value="express">Express</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-save"></i> Create Shipment
                </button>
            </form>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>


    <!-- Firebase Integration -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, setDoc, getDoc, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBtGrZU2HRXUsZaEWNFs3-lXgyWMezzzOg",
            authDomain: "cargolens-fcd66.firebaseapp.com",
            projectId: "cargolens-fcd66",
            storageBucket: "cargolens-fcd66.firebasestorage.app",
            messagingSenderId: "981220438640",
            appId: "1:981220438640:web:236dc1784e9017f2463ab5",
            measurementId: "G-4C95FEXHPX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebase = {
            app,
            auth,
            db,
            analytics,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            getDocs,
            addDoc,
            collection,
            updateDoc,
            deleteDoc,
            doc,
            setDoc,
            getDoc,
            query,
            where,
            orderBy,
            limit
        };
        
        console.log("Firebase initialized successfully");
    </script>


    <script>
        // Demo data for each role
        const demoData = {
            admin: {
                shipments: [
                    { id: 'CL-2024-087', recipient: 'Chanda Bwalya', phone: '+260 966 111 222', city: 'lusaka', address: '123 Cairo Road, Lusaka', weight: '5kg', dimensions: '30x20x15 cm', priority: 'urgent', status: 'in-transit', driver: 'Mike Johnson', value: 2500, created: '2024-01-15' },
                    { id: 'CL-2024-086', recipient: 'Mwila Phiri', phone: '+260 977 333 444', city: 'ndola', address: '456 Broadway, Ndola', weight: '12kg', dimensions: '40x30x25 cm', priority: 'standard', status: 'pending', driver: null, value: 1800, created: '2024-01-16' },
                    { id: 'CL-2024-085', recipient: 'Bwalya Lungu', phone: '+260 955 555 666', city: 'kitwe', address: '789 Freedom Way, Kitwe', weight: '8kg', dimensions: '25x20x15 cm', priority: 'express', status: 'delivered', driver: 'Emily Davis', value: 3200, created: '2024-01-14' },
                    { id: 'CL-2024-084', recipient: 'John Mulenga', phone: '+260 978 777 888', city: 'livingstone', address: '321 Mosi Road, Livingstone', weight: '15kg', dimensions: '50x40x30 cm', priority: 'express', status: 'in-transit', driver: 'Mike Johnson', value: 4200, created: '2024-01-17' },
                    { id: 'CL-2024-083', recipient: 'Sarah Mwale', phone: '+260 966 999 000', city: 'kabwe', address: '555 Independence Ave, Kabwe', weight: '3kg', dimensions: '20x15x10 cm', priority: 'standard', status: 'delivered', driver: 'James Banda', value: 1500, created: '2024-01-13' }
                ],
                drivers: [
                    { id: 'DRV-001', name: 'Mike Johnson', phone: '+260 966 123 456', vehicle: 'Toyota Hilux KAB 1234', status: 'active', city: 'lusaka', rating: 4.8, deliveries: 245, currentStatus: 'on-delivery' },
                    { id: 'DRV-002', name: 'Emily Davis', phone: '+260 977 654 321', vehicle: 'Ford Transit ND 5678', status: 'active', city: 'ndola', rating: 4.9, deliveries: 198, currentStatus: 'available' },
                    { id: 'DRV-003', name: 'James Banda', phone: '+260 955 789 123', vehicle: 'Nissan Van LW 9012', status: 'offline', city: 'livingstone', rating: 4.6, deliveries: 167, currentStatus: 'off-duty' },
                    { id: 'DRV-004', name: 'Peter Chanda', phone: '+260 978 456 789', vehicle: 'Toyota Hiace LSK 3456', status: 'active', city: 'lusaka', rating: 4.7, deliveries: 132, currentStatus: 'on-delivery' },
                    { id: 'DRV-005', name: 'Lisa Mwamba', phone: '+260 966 987 654', vehicle: 'Suzuki Carry KIT 7890', status: 'active', city: 'kitwe', rating: 4.5, deliveries: 98, currentStatus: 'available' }
                ],
                nextShipmentId: 88,
                nextDriverId: 6
            },
            driver: {
                driverInfo: {
                    name: 'Mike Johnson',
                    id: 'DRV-001',
                    phone: '+260 966 123 456',
                    vehicle: 'Toyota Hilux KAB 1234',
                    rating: 4.8,
                    totalDeliveries: 245,
                    earningsToday: 1240,
                    status: 'active'
                },
                tasks: [
                    { id: 'CL-2024-087', recipient: 'Chanda Bwalya', phone: '+260 966 111 222', city: 'lusaka', address: '123 Cairo Road, Lusaka', weight: '5kg', priority: 'urgent', status: 'in-progress', eta: '2:30 PM', notes: 'Medical supplies - handle with care' },
                    { id: 'CL-2024-084', recipient: 'John Mulenga', phone: '+260 978 777 888', city: 'lusaka', address: '321 Mosi Road, Lusaka', weight: '15kg', priority: 'express', status: 'pending', eta: '3:45 PM', notes: 'Fragile items' },
                    { id: 'CL-2024-090', recipient: 'Maria Banda', phone: '+260 955 444 555', city: 'lusaka', address: '789 Cairo Road, Lusaka', weight: '8kg', priority: 'standard', status: 'pending', eta: '4:30 PM', notes: 'Office documents' },
                    { id: 'CL-2024-091', recipient: 'David Phiri', phone: '+260 977 666 777', city: 'lusaka', address: '456 Freedom Way, Lusaka', weight: '12kg', priority: 'standard', status: 'pending', eta: '5:15 PM', notes: 'Electronics' }
                ],
                history: [
                    { id: 'CL-2024-083', recipient: 'Sarah Mwale', date: '2024-01-13', status: 'delivered', rating: 5, feedback: 'Excellent service!' },
                    { id: 'CL-2024-082', recipient: 'Thomas Lungu', date: '2024-01-12', status: 'delivered', rating: 4, feedback: 'On time delivery' },
                    { id: 'CL-2024-081', recipient: 'Grace Chanda', date: '2024-01-11', status: 'delivered', rating: 5, feedback: 'Very professional' },
                    { id: 'CL-2024-080', recipient: 'Andrew Mwamba', date: '2024-01-10', status: 'delivered', rating: 4, feedback: 'Good communication' }
                ]
            },
            dispatcher: {
                assignments: [
                    { id: 'CL-2024-091', recipient: 'UTH Hospital', city: 'lusaka', priority: 'urgent', type: 'Medical Supplies', status: 'unassigned', deadline: '2:00 PM' },
                    { id: 'CL-2024-092', recipient: 'Manda Hill Offices', city: 'lusaka', priority: 'high', type: 'Business Documents', status: 'assigned', driver: 'Mike Johnson', deadline: '3:30 PM' },
                    { id: 'CL-2024-093', recipient: 'Woodlands School', city: 'lusaka', priority: 'standard', type: 'Office Supplies', status: 'unassigned', deadline: '5:00 PM' },
                    { id: 'CL-2024-094', recipient: 'East Park Mall', city: 'lusaka', priority: 'standard', type: 'Retail Goods', status: 'assigned', driver: 'Peter Chanda', deadline: '4:15 PM' },
                    { id: 'CL-2024-095', recipient: 'Zambia National Bank', city: 'lusaka', priority: 'urgent', type: 'Financial Documents', status: 'unassigned', deadline: '1:30 PM' }
                ],
                drivers: [
                    { id: 'DRV-001', name: 'Mike Johnson', status: 'on-delivery', currentTask: 'CL-2024-092', location: 'lusaka', eta: '45 mins', capacity: 'Medium load' },
                    { id: 'DRV-004', name: 'Peter Chanda', status: 'on-delivery', currentTask: 'CL-2024-094', location: 'lusaka', eta: '1.5 hours', capacity: 'Heavy load' },
                    { id: 'DRV-002', name: 'Emily Davis', status: 'available', currentTask: 'None', location: 'ndola', eta: 'Ready', capacity: 'Available' },
                    { id: 'DRV-005', name: 'Lisa Mwamba', status: 'available', currentTask: 'None', location: 'kitwe', eta: 'Ready', capacity: 'Light load' },
                    { id: 'DRV-003', name: 'James Banda', status: 'offline', currentTask: 'Off-duty', location: 'livingstone', eta: 'N/A', capacity: 'Unavailable' }
                ],
                alerts: [
                    { id: 'ALT-001', type: 'warning', message: 'Heavy traffic reported on Cairo Road', time: '10:30 AM', priority: 'medium' },
                    { id: 'ALT-002', type: 'urgent', message: 'Medical delivery URGENT - needs immediate dispatch', time: '11:15 AM', priority: 'high' },
                    { id: 'ALT-003', type: 'info', message: 'Driver Mike Johnson running 15 minutes ahead of schedule', time: '11:45 AM', priority: 'low' },
                    { id: 'ALT-004', type: 'warning', message: 'Vehicle DRV-004 requires maintenance check', time: '12:00 PM', priority: 'medium' }
                ]
            }
        };

        // Zambian Cities Coordinates
        const zambiaCities = {
            lusaka: { lat: -15.4167, lng: 28.2833, name: 'Lusaka' },
            ndola: { lat: -12.9667, lng: 28.6333, name: 'Ndola' },
            kitwe: { lat: -12.8167, lng: 28.2000, name: 'Kitwe' },
            livingstone: { lat: -17.8417, lng: 25.8542, name: 'Livingstone' },
            kabwe: { lat: -14.4333, lng: 28.4500, name: 'Kabwe' },
            chipata: { lat: -13.6333, lng: 32.6500, name: 'Chipata' },
            solwezi: { lat: -12.1833, lng: 26.4000, name: 'Solwezi' },
            mongu: { lat: -15.2775, lng: 23.1358, name: 'Mongu' }
        };

        // Application State
        let currentUser = null;
        let currentRole = null;
        let currentDashboard = null;
        let currentPage = 'overview';
        let maps = {};
        let userData = {};

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CargoLens Platform Loading...');
            
            // Setup demo accounts click events
            document.querySelectorAll('.demo-account').forEach(account => {
                account.addEventListener('click', function() {
                    const email = this.dataset.email;
                    const password = this.dataset.password;
                    document.getElementById('authEmail').value = email;
                    document.getElementById('authPassword').value = password;
                    showToast('Demo credentials loaded', 'success');
                });
            });
            
            // Simulate loading
            setTimeout(() => {
                document.getElementById('loadingScreen').classList.add('hidden');
                setupEventListeners();
                checkAuthState();
            }, 1500);
        });

        function setupEventListeners() {
            // Auth form
            document.getElementById('authForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleAuth();
            });

            // Logout buttons
            document.getElementById('adminLogoutBtn')?.addEventListener('click', logout);
            document.getElementById('driverLogoutBtn')?.addEventListener('click', logout);
            document.getElementById('dispatcherLogoutBtn')?.addEventListener('click', logout);

            // Menu toggles
            document.getElementById('menuToggle')?.addEventListener('click', function() {
                toggleSidebar('sidebar', 'sidebarOverlay');
            });
            document.getElementById('driverMenuToggle')?.addEventListener('click', function() {
                toggleSidebar('driverSidebar', 'driverSidebarOverlay');
            });
            document.getElementById('dispatcherMenuToggle')?.addEventListener('click', function() {
                toggleSidebar('dispatcherSidebar', 'dispatcherSidebarOverlay');
            });

            // Profile buttons
            document.getElementById('profileBtnMobile')?.addEventListener('click', showProfileModal);
            document.getElementById('driverProfileBtnMobile')?.addEventListener('click', showProfileModal);
            document.getElementById('dispatcherProfileBtnMobile')?.addEventListener('click', showProfileModal);

            // Navigation items
            setupNavigation();
            
            // Package form submission
            document.getElementById('addPackageForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                addNewShipment();
            });

            // Driver form submission
            document.getElementById('addDriverForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                addNewDriver();
            });

            // Add button
            document.getElementById('adminAddBtn')?.addEventListener('click', function() {
                showModal('addPackageModal');
            });

            // Driver status button
            document.getElementById('driverStatusBtn')?.addEventListener('click', updateDriverStatus);

            // Alert button
            document.getElementById('dispatcherAlertBtn')?.addEventListener('click', function() {
                navigateToPage('dispatcher-alerts');
            });

            // Window resize handler
            window.addEventListener('resize', handleResize);
        }

        function setupNavigation() {
            // Admin navigation
            document.querySelectorAll('#sidebar .nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                    
                    // Update active state in sidebar
                    document.querySelectorAll('#sidebar .nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 1024) {
                        toggleSidebar('sidebar', 'sidebarOverlay');
                    }
                });
            });

            // Driver navigation
            document.querySelectorAll('#driverSidebar .nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                    
                    // Update active state in sidebar
                    document.querySelectorAll('#driverSidebar .nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 1024) {
                        toggleSidebar('driverSidebar', 'driverSidebarOverlay');
                    }
                });
            });

            // Dispatcher navigation
            document.querySelectorAll('#dispatcherSidebar .nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const page = this.dataset.page;
                    navigateToPage(page);
                    
                    // Update active state in sidebar
                    document.querySelectorAll('#dispatcherSidebar .nav-item').forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Close sidebar on mobile
                    if (window.innerWidth < 1024) {
                        toggleSidebar('dispatcherSidebar', 'dispatcherSidebarOverlay');
                    }
                });
            });

            // Bottom navigation
            setupBottomNavigation();
        }

        function setupBottomNavigation() {
            // Admin bottom nav
            document.querySelectorAll('#adminDashboard .bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const onclickAttr = this.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/(navigateToPage|showProfileModal)\(['"]([^'"]+)['"]\)/);
                        if (match) {
                            const func = match[1];
                            const param = match[2];
                            if (func === 'navigateToPage') {
                                navigateToPage(param);
                            } else if (func === 'showProfileModal') {
                                showProfileModal();
                            }
                            
                            // Update active state
                            document.querySelectorAll('#adminDashboard .bottom-nav-item').forEach(nav => nav.classList.remove('active'));
                            this.classList.add('active');
                        }
                    }
                });
            });

            // Driver bottom nav
            document.querySelectorAll('#driverDashboard .bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const onclickAttr = this.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/(navigateToPage|showProfileModal)\(['"]([^'"]+)['"]\)/);
                        if (match) {
                            const func = match[1];
                            const param = match[2];
                            if (func === 'navigateToPage') {
                                navigateToPage(param);
                            } else if (func === 'showProfileModal') {
                                showProfileModal();
                            }
                            
                            // Update active state
                            document.querySelectorAll('#driverDashboard .bottom-nav-item').forEach(nav => nav.classList.remove('active'));
                            this.classList.add('active');
                        }
                    }
                });
            });

            // Dispatcher bottom nav
            document.querySelectorAll('#dispatcherDashboard .bottom-nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const onclickAttr = this.getAttribute('onclick');
                    if (onclickAttr) {
                        const match = onclickAttr.match(/(navigateToPage|showProfileModal)\(['"]([^'"]+)['"]\)/);
                        if (match) {
                            const func = match[1];
                            const param = match[2];
                            if (func === 'navigateToPage') {
                                navigateToPage(param);
                            } else if (func === 'showProfileModal') {
                                showProfileModal();
                            }
                            
                            // Update active state
                            document.querySelectorAll('#dispatcherDashboard .bottom-nav-item').forEach(nav => nav.classList.remove('active'));
                            this.classList.add('active');
                        }
                    }
                });
            });
        }

        function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            // Demo accounts with pre-loaded data
            const demoAccounts = {
                'admin@cargolens.co.zm': { 
                    password: 'admin123', 
                    name: 'Demo Administrator',
                    role: 'admin',
                    displayName: 'Admin'
                },
                'driver@cargolens.co.zm': { 
                    password: 'driver123', 
                    name: 'Mike Johnson',
                    role: 'driver',
                    displayName: 'Mike'
                },
                'dispatcher@cargolens.co.zm': { 
                    password: 'dispatcher123', 
                    name: 'Demo Dispatcher',
                    role: 'dispatcher',
                    displayName: 'Dispatcher'
                }
            };
            
            // Check if it's a demo account
            if (demoAccounts[email] && demoAccounts[email].password === password) {
                // Demo account login
                const account = demoAccounts[email];
                
                currentUser = {
                    email: email,
                    name: account.name,
                    displayName: account.displayName,
                    role: account.role,
                    isDemo: true
                };
                currentRole = account.role;
                
                // Load appropriate demo data based on role
                if (account.role === 'admin') {
                    userData = JSON.parse(JSON.stringify(demoData.admin));
                    showToast('Welcome to Admin Dashboard! Full system control loaded.', 'success');
                } else if (account.role === 'driver') {
                    userData = JSON.parse(JSON.stringify(demoData.driver));
                    showToast('Welcome Mike Johnson! Your delivery tasks are loaded.', 'success');
                } else if (account.role === 'dispatcher') {
                    userData = JSON.parse(JSON.stringify(demoData.dispatcher));
                    showToast('Welcome Dispatcher! Operations control loaded.', 'success');
                }
                
                // Store session
                localStorage.setItem('cargolens_session', JSON.stringify({
                    email: email,
                    role: currentRole,
                    name: currentUser.name,
                    userData: userData,
                    isDemo: true,
                    timestamp: Date.now()
                }));
                
                showDashboard();
                initializeDashboard();
            } else if (email && password) {
                // NEW USER REGISTRATION - Fresh start with no data
                const name = email.split('@')[0];
                const displayName = name.charAt(0).toUpperCase() + name.slice(1);
                
                // Default to admin role for new users
                let role = 'admin';
                
                currentUser = {
                    email: email,
                    name: displayName,
                    displayName: displayName,
                    role: role,
                    isDemo: false
                };
                currentRole = role;
                
                // FRESH START - Empty data for new users
                userData = {
                    shipments: [],
                    drivers: [],
                    nextShipmentId: 1,
                    nextDriverId: 1
                };
                
                // Store session
                localStorage.setItem('cargolens_session', JSON.stringify({
                    email: email,
                    role: currentRole,
                    name: currentUser.name,
                    userData: userData,
                    isDemo: false,
                    timestamp: Date.now()
                }));
                
                showToast(`Welcome ${displayName}! Fresh start with empty dashboard.`, 'success');
                showDashboard();
                initializeDashboard();
            } else {
                showToast('Please enter email and password', 'error');
            }
        }

        function checkAuthState() {
            const session = localStorage.getItem('cargolens_session');
            if (session) {
                try {
                    const data = JSON.parse(session);
                    // Check if session is less than 24 hours old
                    if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                        currentUser = {
                            name: data.name,
                            role: data.role,
                            displayName: data.name.split(' ')[0],
                            email: data.email,
                            isDemo: data.isDemo || false
                        };
                        currentRole = data.role;
                        userData = data.userData || {
                            shipments: [],
                            drivers: [],
                            nextShipmentId: 1,
                            nextDriverId: 1
                        };
                        showDashboard();
                        initializeDashboard();
                        return;
                    }
                } catch (e) {
                    console.log('Session expired or invalid');
                }
            }
            // Show auth page if no valid session
            document.getElementById('authPage').classList.remove('hidden');
        }

        function showDashboard() {
    // Hide auth page
    document.getElementById('authPage').classList.add('hidden');
    
    // Hide all dashboards
    document.querySelectorAll('.dashboard-container').forEach(d => {
        d.classList.remove('active');
    });
    
    // Clean up any existing maps
    cleanupMaps();
    
    // Show appropriate dashboard based on role
    if (currentRole === 'admin') {
        currentDashboard = 'admin';
        document.getElementById('adminDashboard').classList.add('active');
    } else if (currentRole === 'driver') {
        currentDashboard = 'driver';
        document.getElementById('driverDashboard').classList.add('active');
        // Initialize with delay to ensure DOM is ready
        setTimeout(() => {
            initializeDriverDashboard();
        }, 100);
    } else if (currentRole === 'dispatcher') {
        currentDashboard = 'dispatcher';
        document.getElementById('dispatcherDashboard').classList.add('active');
        // Initialize with delay
        setTimeout(() => {
            initializeDispatcherDashboard();
        }, 100);
    }
    
    // Initialize responsive features
    handleResize();
}

        function initializeDashboard() {
            updateUserInfo();
            
            if (currentRole === 'admin') {
                updateAdminDashboard();
            } else if (currentRole === 'driver') {
                initializeDriverDashboard();
            } else if (currentRole === 'dispatcher') {
                initializeDispatcherDashboard();
            }
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            // Update based on current dashboard
            if (currentDashboard === 'admin') {
                document.getElementById('adminAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
                document.getElementById('adminUserName').textContent = currentUser.name;
            } else if (currentDashboard === 'driver') {
                document.getElementById('driverAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
                document.getElementById('driverUserName').textContent = currentUser.name;
                document.getElementById('driverDashboardSubtitle').textContent = `Welcome ${currentUser.name}`;
            } else if (currentDashboard === 'dispatcher') {
                document.getElementById('dispatcherAvatar').textContent = currentUser.displayName.charAt(0).toUpperCase();
                document.getElementById('dispatcherUserName').textContent = currentUser.name;
            }
            
            // Update profile modal
            document.getElementById('profileAvatarLarge').textContent = currentUser.displayName.charAt(0).toUpperCase();
            document.getElementById('profileUserName').textContent = currentUser.name;
            document.getElementById('profileUserEmail').textContent = currentUser.email;
            document.getElementById('profileUserRole').textContent = currentRole.charAt(0).toUpperCase() + currentRole.slice(1);
            document.getElementById('profileAccountType').textContent = currentUser.isDemo ? `Demo ${currentRole}` : `Standard ${currentRole}`;
        }

        function updateAdminDashboard() {
            if (!userData) return;
            
            // Populate shipments table
            populateShipmentsTable();
            
            // Populate drivers table
            populateDriversTable();
            
            // Initialize maps
            initializeAdminMap();
            initializeAdminTrackingMap();
            
            // Initialize charts
            initializeAdminCharts();
            
            navigateToPage('admin-overview');
        }

       function initializeDriverDashboard() {
    if (!userData) return;
    
    // Update user info first
    updateUserInfo();
    
    // Populate driver tasks
    populateDriverTasks();
    
    // Populate driver history
    populateDriverHistory();
    
    // Initialize driver map with delay to ensure DOM is ready
    setTimeout(() => {
        if (currentPage === 'driver-map' || currentPage === 'driver-overview') {
            initializeDriverMap();
        }
    }, 300);
    
    navigateToPage('driver-overview');
}

        function initializeDispatcherDashboard() {
            if (!userData) return;
            
            // Populate dispatcher assignments
            populateDispatcherAssignments();
            
            // Populate dispatcher drivers
            populateDispatcherDrivers();
            
            // Populate dispatcher alerts
            populateDispatcherAlerts();
            
            // Initialize dispatcher maps
            initializeDispatcherMap();
            initializeDispatcherTrackingMap();
            
            navigateToPage('dispatcher-overview');
        }

        function populateShipmentsTable() {
            const container = document.getElementById('allShipmentsTable');
            if (!container || !userData.shipments) return;
            
            container.innerHTML = userData.shipments.map(shipment => `
                <tr>
                    <td><strong>${shipment.id}</strong></td>
                    <td>
                        <div>${shipment.recipient}</div>
                        <div style="font-size: 0.85rem; color: var(--gray);">${shipment.phone}</div>
                    </td>
                    <td>${zambiaCities[shipment.city]?.name || shipment.city}</td>
                    <td><span class="status-badge status-${shipment.status}">${shipment.status.replace('-', ' ').toUpperCase()}</span></td>
                    <td>${shipment.driver || 'Unassigned'}</td>
                    <td>ZK ${shipment.value?.toLocaleString() || '0'}</td>
                    <td>${shipment.created}</td>
                    <td>
                        <button class="icon-btn" onclick="assignShipment('${shipment.id}')" style="background: transparent; color: var(--primary);">
                            <i class="fas fa-user-check"></i>
                        </button>
                        <button class="icon-btn" onclick="editShipment('${shipment.id}')" style="background: transparent; color: var(--warning); margin-left: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateDriversTable() {
            const container = document.getElementById('driversTable');
            if (!container || !userData.drivers) return;
            
            container.innerHTML = userData.drivers.map(driver => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar" style="width: 36px; height: 36px; font-size: 0.9rem;">${driver.name.charAt(0)}</div>
                            <div>
                                <div style="font-weight: 600;">${driver.name}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">ID: ${driver.id}</div>
                            </div>
                        </div>
                    </td>
                    <td>${driver.phone}</td>
                    <td>${driver.vehicle}</td>
                    <td><span class="status-badge status-${driver.status}">${driver.status.toUpperCase()}</span></td>
                    <td>${driver.rating} ★</td>
                    <td>${driver.deliveries}</td>
                    <td>
                        <button class="icon-btn" onclick="messageDriver('${driver.id}')" style="background: transparent; color: var(--primary);">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="icon-btn" onclick="editDriver('${driver.id}')" style="background: transparent; color: var(--warning); margin-left: 8px;">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function populateDriverTasks() {
            const container = document.getElementById('driverTasksContent');
            if (!container || !userData.tasks) return;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Today's Delivery Tasks</h2>
                        <button class="btn btn-sm" onclick="refreshTasks()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${userData.tasks.map(task => `
                                <div class="driver-task-card">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                        <div>
                                            <h3 style="margin-bottom: 5px;">${task.recipient}</h3>
                                            <p style="color: var(--gray); font-size: 0.9rem;">${task.id} • ${zambiaCities[task.city]?.name || task.city}</p>
                                        </div>
                                        <span class="status-badge ${task.priority === 'urgent' ? 'priority-high' : task.priority === 'express' ? 'priority-medium' : 'priority-low'}">${task.priority.toUpperCase()}</span>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <p style="margin-bottom: 8px;"><i class="fas fa-map-marker-alt" style="color: var(--primary); margin-right: 8px;"></i>${task.address}</p>
                                        <p><i class="fas fa-phone" style="color: var(--primary); margin-right: 8px;"></i>${task.phone}</p>
                                        ${task.notes ? `<p style="margin-top: 8px; font-size: 0.9rem; color: var(--warning);"><i class="fas fa-exclamation-circle" style="margin-right: 8px;"></i>${task.notes}</p>` : ''}
                                    </div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <p style="font-size: 0.9rem; color: var(--gray);">Status:</p>
                                            <p style="font-weight: 600; color: ${task.status === 'in-progress' ? 'var(--primary)' : task.status === 'pending' ? 'var(--warning)' : 'var(--success)'}">
                                                ${task.status.toUpperCase().replace('-', ' ')}
                                            </p>
                                        </div>
                                        <div style="text-align: right;">
                                            <p style="font-size: 0.9rem; color: var(--gray);">ETA:</p>
                                            <p style="font-weight: 600;">${task.eta}</p>
                                        </div>
                                        <button class="scan-qr-btn" onclick="scanDelivery('${task.id}')">
                                            <i class="fas fa-qrcode"></i>
                                            Scan
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function populateDriverHistory() {
            const container = document.getElementById('driverHistoryContent');
            if (!container || !userData.history) return;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Delivery History</h2>
                        <button class="btn btn-sm" onclick="exportHistory()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tracking ID</th>
                                    <th>Recipient</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Rating</th>
                                    <th>Feedback</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userData.history.map(delivery => `
                                    <tr>
                                        <td><strong>${delivery.id}</strong></td>
                                        <td>${delivery.recipient}</td>
                                        <td>${delivery.date}</td>
                                        <td><span class="status-badge status-delivered">DELIVERED</span></td>
                                        <td>${'★'.repeat(delivery.rating)}${'☆'.repeat(5-delivery.rating)}</td>
                                        <td>${delivery.feedback || 'No feedback'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function populateDispatcherAssignments() {
            const container = document.getElementById('dispatcherAssignmentsContent');
            if (!container || !userData.assignments) return;
            
            container.innerHTML = `
                <div style="display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="createNewAssignment()">
                        <i class="fas fa-plus"></i> New Assignment
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Pending Assignments</h2>
                        <select class="form-control" style="width: auto; padding: 8px 16px;" onchange="filterAssignments(this.value)">
                            <option value="all">All Priority</option>
                            <option value="urgent">Urgent</option>
                            <option value="high">High</option>
                            <option value="standard">Standard</option>
                        </select>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tracking ID</th>
                                    <th>Recipient</th>
                                    <th>City</th>
                                    <th>Priority</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Assigned Driver</th>
                                    <th>Deadline</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${userData.assignments.map(assignment => `
                                    <tr>
                                        <td><strong>${assignment.id}</strong></td>
                                        <td>${assignment.recipient}</td>
                                        <td>${zambiaCities[assignment.city]?.name || assignment.city}</td>
                                        <td><span class="status-badge ${assignment.priority === 'urgent' ? 'priority-high' : assignment.priority === 'high' ? 'priority-medium' : 'priority-low'}">${assignment.priority.toUpperCase()}</span></td>
                                        <td>${assignment.type}</td>
                                        <td><span class="status-badge ${assignment.status === 'assigned' ? 'status-active' : 'status-pending'}">${assignment.status.toUpperCase()}</span></td>
                                        <td>${assignment.driver || 'Unassigned'}</td>
                                        <td>${assignment.deadline}</td>
                                        <td>
                                            <button class="icon-btn" onclick="assignDriver('${assignment.id}')" style="background: transparent; color: var(--primary);">
                                                <i class="fas fa-user-check"></i>
                                            </button>
                                            <button class="icon-btn" onclick="editAssignment('${assignment.id}')" style="background: transparent; color: var(--warning); margin-left: 8px;">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function populateDispatcherDrivers() {
            const container = document.getElementById('dispatcherDriversTable');
            if (!container || !userData.drivers) return;
            
            container.innerHTML = userData.drivers.map(driver => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="user-avatar" style="width: 36px; height: 36px; font-size: 0.9rem;">${driver.name.charAt(0)}</div>
                            <div>
                                <div style="font-weight: 600;">${driver.name}</div>
                                <div style="font-size: 0.85rem; color: var(--gray);">ID: ${driver.id}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="status-badge status-${driver.status === 'on-delivery' ? 'active' : driver.status === 'available' ? 'active' : 'offline'}">${driver.status.toUpperCase().replace('-', ' ')}</span></td>
                    <td>${driver.currentTask}</td>
                    <td>${zambiaCities[driver.location]?.name || driver.location}</td>
                    <td>${driver.eta}</td>
                    <td>
                        <div class="dispatch-controls">
                            <button class="icon-btn" onclick="messageDispatcher('${driver.id}')" style="background: transparent; color: var(--primary);">
                                <i class="fas fa-comment"></i>
                            </button>
                            <button class="icon-btn" onclick="reassignDriver('${driver.id}')" style="background: transparent; color: var(--warning);">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function populateDispatcherAlerts() {
            const container = document.getElementById('dispatcherAlertsContent');
            if (!container || !userData.alerts) return;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">System Alerts</h2>
                        <button class="btn btn-sm" onclick="markAllAsRead()">
                            <i class="fas fa-check-double"></i> Mark All Read
                        </button>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            ${userData.alerts.map(alert => `
                                <div style="display: flex; align-items: flex-start; gap: 15px; padding: 15px; background: ${alert.type === 'urgent' ? '#fee2e2' : alert.type === 'warning' ? '#fef3c7' : '#dbeafe'}; border-radius: var(--radius); border-left: 4px solid ${alert.type === 'urgent' ? 'var(--danger)' : alert.type === 'warning' ? 'var(--warning)' : 'var(--primary)'};">
                                    <div style="background: ${alert.type === 'urgent' ? 'var(--danger)' : alert.type === 'warning' ? 'var(--warning)' : 'var(--primary)'}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="fas fa-${alert.type === 'urgent' ? 'exclamation-triangle' : alert.type === 'warning' ? 'exclamation-circle' : 'info-circle'}"></i>
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; margin-bottom: 5px;">${alert.message}</div>
                                        <div style="font-size: 0.85rem; color: var(--gray);">${alert.time}</div>
                                    </div>
                                    <span class="status-badge ${alert.priority === 'high' ? 'priority-high' : alert.priority === 'medium' ? 'priority-medium' : 'priority-low'}">${alert.priority.toUpperCase()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function initializeAdminCharts() {
            // Shipment volume chart
            setTimeout(() => {
                const shipmentCtx = document.getElementById('adminShipmentChart');
                if (shipmentCtx) {
                    new Chart(shipmentCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                            datasets: [{
                                label: 'Shipments',
                                data: [12, 19, 15, 25, 22, 18, 10],
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                }
                            }
                        }
                    });
                }
                
                // Revenue chart
                const revenueCtx = document.getElementById('adminRevenueChart');
                if (revenueCtx) {
                    new Chart(revenueCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Revenue (ZK)',
                                data: [45000, 52000, 48000, 62000, 58000, 70000],
                                backgroundColor: '#10b981'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: 'rgba(0,0,0,0.05)'
                                    }
                                }
                            }
                        }
                    });
                }
            }, 100);
        }

        function initializeAdminMap() {
            const mapElement = document.getElementById('adminMap');
            if (!mapElement) return;
            
            const map = L.map('adminMap').setView([-13.1333, 27.8500], 6);
            maps.admin = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add driver markers
            if (userData.drivers) {
                userData.drivers.filter(d => d.status === 'active').forEach(driver => {
                    const city = zambiaCities[driver.city.toLowerCase()];
                    if (city) {
                        L.marker([city.lat, city.lng], {
                            icon: L.divIcon({
                                html: `<div style="background: #2563eb; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
                                    <i class="fas fa-truck"></i>
                                </div>`,
                                className: 'driver-marker',
                                iconSize: [36, 36]
                            })
                        }).addTo(map)
                        .bindPopup(`<b>${driver.name}</b><br>${driver.vehicle}<br>Status: ${driver.currentStatus}`);
                    }
                });
            }
        }

        function initializeAdminTrackingMap() {
            const mapElement = document.getElementById('adminTrackingMap');
            if (!mapElement) return;
            
            const map = L.map('adminTrackingMap').setView([-13.1333, 27.8500], 7);
            maps.adminTracking = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add shipment markers
            if (userData.shipments) {
                userData.shipments.filter(s => s.status === 'in-transit').forEach(shipment => {
                    const city = zambiaCities[shipment.city.toLowerCase()];
                    if (city) {
                        const lat = city.lat + (Math.random() * 0.5 - 0.25);
                        const lng = city.lng + (Math.random() * 0.5 - 0.25);
                        
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: `<div style="background: ${shipment.priority === 'urgent' ? '#ef4444' : shipment.priority === 'express' ? '#f59e0b' : '#2563eb'}; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">
                                    <i class="fas fa-box"></i>
                                </div>`,
                                className: 'shipment-marker',
                                iconSize: [40, 40]
                            })
                        }).addTo(map)
                        .bindPopup(`<b>${shipment.id}</b><br>To: ${shipment.recipient}<br>Driver: ${shipment.driver || 'Unassigned'}<br>Status: In Transit`);
                    }
                });
            }
        }

        function initializeDriverMap() {
    // Wait for the DOM to be ready
    setTimeout(() => {
        const mapElement = document.getElementById('driverMap');
        if (!mapElement) {
            console.warn('Driver map element not found yet, retrying...');
            setTimeout(initializeDriverMap, 100);
            return;
        }
        
        // Check if map is already initialized
        if (maps.driver) {
            maps.driver.invalidateSize();
            return;
        }
        
        try {
            const map = L.map('driverMap').setView([-15.4167, 28.2833], 12);
            maps.driver = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add route markers for Lusaka
            const locations = [
                { lat: -15.4167, lng: 28.2833, name: 'Depot' },
                { lat: -15.4180, lng: 28.2850, name: 'Stop 1: Cairo Road' },
                { lat: -15.4200, lng: 28.2900, name: 'Stop 2: Manda Hill' },
                { lat: -15.4150, lng: 28.2950, name: 'Stop 3: Woodlands' },
                { lat: -15.4100, lng: 28.3000, name: 'Stop 4: East Park' }
            ];
            
            locations.forEach((loc, index) => {
                L.marker([loc.lat, loc.lng], {
                    icon: L.divIcon({
                        html: `<div style="background: ${index === 0 ? '#10b981' : '#2563eb'}; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
                            ${index === 0 ? '<i class="fas fa-warehouse"></i>' : index}
                        </div>`,
                        className: 'route-marker',
                        iconSize: [32, 32]
                    })
                }).addTo(map)
                .bindPopup(`<b>${loc.name}</b>`);
            });
            
            // Draw route line
            const routeLine = L.polyline(locations.map(loc => [loc.lat, loc.lng]), {
                color: '#2563eb',
                weight: 3,
                opacity: 0.7,
                dashArray: '10, 10'
            }).addTo(map);
            
            // Ensure map renders properly
            setTimeout(() => {
                if (map) map.invalidateSize();
            }, 100);
            
        } catch (error) {
            console.error('Error initializing driver map:', error);
        }
    }, 100);
}
        function initializeDispatcherMap() {
            const mapElement = document.getElementById('dispatcherMap');
            if (!mapElement) return;
            
            const map = L.map('dispatcherMap').setView([-13.1333, 27.8500], 6);
            maps.dispatcher = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add driver markers
            if (userData.drivers) {
                userData.drivers.forEach(driver => {
                    const city = zambiaCities[driver.location.toLowerCase()];
                    if (city) {
                        const color = driver.status === 'on-delivery' ? '#f59e0b' : driver.status === 'available' ? '#10b981' : '#64748b';
                        
                        L.marker([city.lat, city.lng], {
                            icon: L.divIcon({
                                html: `<div style="background: ${color}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
                                    <i class="fas fa-truck"></i>
                                </div>`,
                                className: 'dispatcher-driver-marker',
                                iconSize: [36, 36]
                            })
                        }).addTo(map)
                        .bindPopup(`<b>${driver.name}</b><br>Status: ${driver.status}<br>Task: ${driver.currentTask}<br>ETA: ${driver.eta}`);
                    }
                });
            }
        }

        function initializeDispatcherTrackingMap() {
            const mapElement = document.getElementById('dispatcherTrackingMap');
            if (!mapElement) return;
            
            const map = L.map('dispatcherTrackingMap').setView([-13.1333, 27.8500], 7);
            maps.dispatcherTracking = map;
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        function toggleSidebar(sidebarId, overlayId) {
            const sidebar = document.getElementById(sidebarId);
            const overlay = document.getElementById(overlayId);
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('active');
                overlay.classList.toggle('active');
            }
        }

       function navigateToPage(page) {
    currentPage = page;
    
    // Hide all pages in current dashboard
    let pagesContainer;
    if (currentDashboard === 'admin') {
        pagesContainer = document.querySelectorAll('#adminDashboard .page-content');
    } else if (currentDashboard === 'driver') {
        pagesContainer = document.querySelectorAll('#driverDashboard .page-content');
    } else if (currentDashboard === 'dispatcher') {
        pagesContainer = document.querySelectorAll('#dispatcherDashboard .page-content');
    }
    
    if (pagesContainer) {
        pagesContainer.forEach(content => {
            content.classList.remove('active');
        });
    }
    
    // Show target page
    const targetPage = document.getElementById(page);
    if (targetPage) {
        targetPage.classList.add('active');
        
        // Initialize map if needed (with delay)
        setTimeout(() => {
            if (page === 'driver-map' && typeof initializeDriverMap === 'function') {
                initializeDriverMap();
            }
            if (page === 'admin-tracking' && maps.adminTracking) {
                refreshTrackingMap();
            }
            if (page === 'dispatcher-tracking' && maps.dispatcherTracking) {
                // Similar refresh for dispatcher
            }
        }, 100);
    }
    
    // Update page title
    updatePageTitle(page);
}
        function updatePageTitle(page) {
            let titleElement;
            let title = '';
            
            if (currentDashboard === 'admin') {
                titleElement = document.getElementById('pageTitle');
                const titles = {
                    'admin-overview': 'Admin Dashboard',
                    'admin-analytics': 'Analytics',
                    'admin-packages': 'Shipments',
                    'admin-drivers': 'Drivers',
                    'admin-tracking': 'Live Tracking',
                    'admin-routes': 'Routes',
                    'admin-reports': 'Reports'
                };
                title = titles[page] || 'Dashboard';
            } else if (currentDashboard === 'driver') {
                titleElement = document.getElementById('driverPageTitle');
                const titles = {
                    'driver-overview': 'Driver Dashboard',
                    'driver-tasks': 'My Tasks',
                    'driver-deliveries': 'Deliveries',
                    'driver-map': 'Route Map',
                    'driver-scanner': 'QR Scanner',
                    'driver-history': 'History'
                };
                title = titles[page] || 'Dashboard';
            } else if (currentDashboard === 'dispatcher') {
                titleElement = document.getElementById('dispatcherPageTitle');
                const titles = {
                    'dispatcher-overview': 'Dispatcher Dashboard',
                    'dispatcher-assignments': 'Assignments',
                    'dispatcher-drivers': 'Driver Management',
                    'dispatcher-routes': 'Route Planning',
                    'dispatcher-tracking': 'Live Tracking',
                    'dispatcher-alerts': 'Alerts'
                };
                title = titles[page] || 'Dashboard';
            }
            
            if (titleElement && title) {
                titleElement.textContent = title;
            }
        }
        function cleanupMaps() {
    // Clean up all existing maps
    Object.keys(maps).forEach(key => {
        if (maps[key] && maps[key].remove) {
            maps[key].remove();
        }
    });
    maps = {};
}

        function showProfileModal() {
            updateUserInfo();
            document.getElementById('profileMemberSince').textContent = new Date().toLocaleDateString();
            showModal('profileModal');
        }

        function addNewShipment() {
            const recipientName = document.getElementById('recipientName').value;
            const recipientPhone = document.getElementById('recipientPhone').value;
            const destinationCity = document.getElementById('destinationCity').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const packageWeight = document.getElementById('packageWeight').value;
            const packageDimensions = document.getElementById('packageDimensions').value;
            const packagePriority = document.getElementById('packagePriority').value;
            
            // Generate shipment ID
            const shipmentId = 'CL-' + new Date().getFullYear() + '-' + String(userData.nextShipmentId).padStart(3, '0');
            userData.nextShipmentId++;
            
            // Create new shipment
            const newShipment = {
                id: shipmentId,
                recipient: recipientName,
                phone: recipientPhone,
                city: destinationCity,
                address: deliveryAddress,
                weight: packageWeight ? packageWeight + 'kg' : 'Not specified',
                dimensions: packageDimensions || 'Not specified',
                priority: packagePriority,
                status: 'pending',
                driver: null,
                created: new Date().toLocaleDateString(),
                value: Math.floor(Math.random() * 5000) + 1000
            };
            
            userData.shipments.unshift(newShipment);
            
            // Save to localStorage
            saveUserData();
            
            // Clear form
            document.getElementById('addPackageForm').reset();
            hideModal('addPackageModal');
            
            // Refresh dashboard
            populateShipmentsTable();
            
            showToast(`New shipment created: ${shipmentId}`, 'success');
        }

        function addNewDriver() {
            const driverName = document.getElementById('driverName').value;
            const driverPhone = document.getElementById('driverPhone').value;
            const driverVehicle = document.getElementById('driverVehicle').value;
            const driverCity = document.getElementById('driverCity').value;
            
            // Create new driver
            const newDriver = {
                id: 'DRV-' + String(userData.nextDriverId).padStart(3, '0'),
                name: driverName,
                phone: driverPhone,
                vehicle: driverVehicle,
                status: 'active',
                city: driverCity,
                rating: 0,
                deliveries: 0,
                currentStatus: 'available'
            };
            
            userData.nextDriverId++;
            userData.drivers.push(newDriver);
            
            // Save to localStorage
            saveUserData();
            
            // Clear form
            document.getElementById('addDriverForm').reset();
            
            // Refresh dashboard
            populateDriversTable();
            refreshAdminMap();
            
            showToast(`New driver added: ${driverName}`, 'success');
        }

        function assignShipment(shipmentId) {
            const shipment = userData.shipments?.find(s => s.id === shipmentId);
            if (!shipment) {
                showToast('Shipment not found', 'error');
                return;
            }
            
            if (!userData.drivers || userData.drivers.length === 0) {
                showToast('No drivers available. Please add drivers first.', 'warning');
                return;
            }
            
            const availableDrivers = userData.drivers.filter(d => d.status === 'active' && d.currentStatus === 'available');
            if (availableDrivers.length > 0) {
                const driver = availableDrivers[0];
                shipment.driver = driver.name;
                shipment.status = 'in-transit';
                driver.currentStatus = 'on-delivery';
                
                saveUserData();
                populateShipmentsTable();
                populateDriversTable();
                
                showToast(`Assigned ${shipmentId} to ${driver.name}`, 'success');
            } else {
                showToast('No available drivers at the moment', 'warning');
            }
        }

        function editShipment(shipmentId) {
            showToast(`Editing shipment: ${shipmentId}`, 'info');
        }

        function messageDriver(driverId) {
            const driver = userData.drivers?.find(d => d.id === driverId);
            if (driver) {
                showToast(`Messaging ${driver.name}...`, 'success');
            }
        }

        function editDriver(driverId) {
            showToast(`Editing driver: ${driverId}`, 'info');
        }

        function updateDriverStatus() {
            const statusBtn = document.getElementById('driverStatusBtn');
            const isOnline = statusBtn.innerHTML.includes('fa-power-off');
            
            if (isOnline) {
                statusBtn.innerHTML = '<i class="fas fa-check-circle"></i>';
                statusBtn.style.background = 'var(--success)';
                statusBtn.style.color = 'white';
                showToast('You are now online and available for deliveries', 'success');
            } else {
                statusBtn.innerHTML = '<i class="fas fa-power-off"></i>';
                statusBtn.style.background = '';
                statusBtn.style.color = '';
                showToast('You are now offline', 'warning');
            }
        }

        function scanDelivery(taskId) {
            showToast(`Scanning delivery ${taskId}...`, 'success');
            setTimeout(() => {
                showToast(`Delivery ${taskId} scanned successfully!`, 'success');
            }, 1000);
        }

        function refreshTasks() {
            showToast('Tasks refreshed', 'success');
        }

        function exportHistory() {
            showToast('Exporting delivery history...', 'success');
            setTimeout(() => {
                showToast('History exported successfully!', 'success');
            }, 1500);
        }

        function createNewAssignment() {
            showToast('Creating new assignment...', 'info');
        }

        function filterAssignments(filter) {
            showToast(`Filtered assignments by: ${filter}`, 'info');
        }

        function assignDriver(assignmentId) {
            showToast(`Assigning driver to ${assignmentId}...`, 'info');
        }

        function editAssignment(assignmentId) {
            showToast(`Editing assignment: ${assignmentId}`, 'info');
        }

        function messageDispatcher(driverId) {
            const driver = userData.drivers?.find(d => d.id === driverId);
            if (driver) {
                showToast(`Messaging ${driver.name}...`, 'success');
            }
        }

        function reassignDriver(driverId) {
            const driver = userData.drivers?.find(d => d.id === driverId);
            if (driver) {
                showToast(`Reassigning ${driver.name}...`, 'info');
            }
        }

        function markAllAsRead() {
            showToast('All alerts marked as read', 'success');
        }

        function refreshDriverMap() {
            if (maps.driver) {
                maps.driver.invalidateSize();
                showToast('Map refreshed', 'success');
            }
        }

        function refreshDispatcherMap() {
            if (maps.dispatcher) {
                maps.dispatcher.invalidateSize();
                showToast('Map refreshed', 'success');
            }
        }

        function filterByCity(city) {
            showToast(`Filtering by ${city === 'all' ? 'all cities' : city}`, 'info');
        }

        function zoomToLusaka() {
            if (maps.adminTracking) {
                maps.adminTracking.setView([zambiaCities.lusaka.lat, zambiaCities.lusaka.lng], 12);
                showToast(`Zoomed to ${zambiaCities.lusaka.name}`, 'success');
            }
        }

        function zoomToNdola() {
            if (maps.adminTracking) {
                maps.adminTracking.setView([zambiaCities.ndola.lat, zambiaCities.ndola.lng], 12);
                showToast(`Zoomed to ${zambiaCities.ndola.name}`, 'success');
            }
        }

        function filterShipments(status) {
            showToast(`Filtered shipments by: ${status}`, 'info');
        }

        function showModal(modalId) {
            document.getElementById(modalId)?.classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 4000);
        }

        function saveUserData() {
            const session = localStorage.getItem('cargolens_session');
            if (session) {
                try {
                    const data = JSON.parse(session);
                    data.userData = userData;
                    localStorage.setItem('cargolens_session', JSON.stringify(data));
                } catch (e) {
                    console.log('Error saving user data');
                }
            }
        }

        function logout() {
            // Save data before logout
            saveUserData();
            
            // Clear session
            localStorage.removeItem('cargolens_session');
            currentUser = null;
            currentRole = null;
            currentDashboard = null;
            userData = {};
            
            // Hide all dashboards
            document.querySelectorAll('.dashboard-container').forEach(d => {
                d.classList.remove('active');
            });
            
            // Show auth page
            document.getElementById('authPage').classList.remove('hidden');
            
            // Reset form
            document.getElementById('authForm').reset();
            
            showToast('Logged out successfully', 'success');
        }

        function handleResize() {
            // Close sidebar on desktop
            if (window.innerWidth >= 1024) {
                document.querySelectorAll('.sidebar').forEach(sidebar => sidebar.classList.remove('active'));
                document.querySelectorAll('.sidebar-overlay').forEach(overlay => overlay.classList.remove('active'));
            }
        }

        // Make functions globally available
        window.navigateToPage = navigateToPage;
        window.showModal = showModal;
        window.hideModal = hideModal;
        window.showToast = showToast;
        window.zoomToLusaka = zoomToLusaka;
        window.zoomToNdola = zoomToNdola;
        window.assignShipment = assignShipment;
        window.editShipment = editShipment;
        window.messageDriver = messageDriver;
        window.editDriver = editDriver;
        window.showProfileModal = showProfileModal;
        window.logout = logout;
        window.updateDriverStatus = updateDriverStatus;
        window.scanDelivery = scanDelivery;
        window.refreshDriverMap = refreshDriverMap;
        window.refreshDispatcherMap = refreshDispatcherMap;
        window.filterByCity = filterByCity;
        window.filterShipments = filterShipments;
    </script>
</body>
</html>